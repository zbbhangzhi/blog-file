### 简介

InnoDB是一个将数据存储到磁盘上的存储引擎。对于更新/写入的数据，先将数据从磁盘中加载到内存，更新后再将数据刷新到磁盘。而磁盘与内存交互的数据，InnoDB采取将数据分为若干页，一页一般为16kb，以页为单位磁盘与内存之间交互传输。

### 行格式

表中的数据一般是以记录为单位进行操作，而记录在磁盘上存放的方式被称为行格式/记录格式；在创建表时声明 ROW_FORMAT=行格式名称

InnoDB设计了四种行格式

#### compact

![image_1c9g4t114n0j1gkro2r1h8h1d1t16.png-42.4kB](https://user-gold-cdn.xitu.io/2019/3/12/169710e8fafc21aa?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

##### 		1.记录的额外信息

​			**变长字段长度列表**

​				变长字段即varchar/varchary/text/blob等，列表内存放记录中这些字段真实数据占用的字节长度，列表形式按列的顺序逆序存放；

​				表示真正字符占用的字节数：如果某个可变字段允许存储的最多字节数=字符数*字符集maxLen，超过255字节并且真实存储的字节数超过127字节则使用2个字节，反之，如果不大于255或者大于255但真实字节数不大于127，使用1个字节。那么总的字节数为各个变长字段占用字节数相加。

​				不保存null值列的长度。如果没有变长字段则没有这个部分。

​			**NULL值列表**

​				存储该记录值为null的列。	

​				首先统计允许存储null的列，并将每个允许存储null的列对应一个二进制位（列值为null二进制为1，反之为0），二进制位按照列的顺序逆序排列；

​				最后，null值列表表示需为整数个字节（一个字节8位），即二进制位个数没有满足的高位补0，比如有三个字段可为null，不足一个字节，那么表示为00000111，十六进制为0x07，如果表中有超过9个字段均为null，则用两个字节表示。

​			**记录头信息**：由5个字节（40位）组成。，包括该记录是否被删除，在记录堆的位置信息，下一条记录的相对位置等。

##### 		2.记录的真实数据

除了用户自定义的列，MySQL还会为每个记录默认添加一些隐藏列

​			**DB_ROW_ID**：没有定义主键及唯一键才会添加行id

​			**DB_TRX_ID**：事务id

​			**DB_ROLL_PTR**：回滚指针

​			**真实列**

​				 不管什么字符集下，某字段声明为char(10)，但实际长度为2字节，那么将会用空格字符填充剩下8个字节；这样是为了在更新这个字段时不产生碎片空间，因为更新时会重新在存储空间中分配一个新的记录空间，原有的空间成为了碎片；varchar没有这个要求。

> 对于CHAR(M)类型的列来说，当列采用的是定长字符集时（如ascii/iso固定1字节），该列占用的字节数不会被加到变长字段长度列表，而如果采用变长字符集时，该列占用的字节数也会被加到变长字段长度列表

​				 当前记录，某字段实际值为null，将存储在null值列表，不在这里存储

​				 每个字段存储以字符集对应形式存储

#### redundant

Redundant行格式是MySQL5.0之前使用的，也分为记录的额外信息和记录的真实数据。

##### 	1.记录的额外信息

​			字段长度偏移列表：按照字段顺序逆序存储所有字段的真实数据的偏移位置，利用相邻数值的差值来计算各列值的长度；只存储每个列在本页中的偏移。如果该列值为null，那么该列对应的偏移量值的第一个比特位作为是否为null的依据，如果为1则为null。

​			记录头信息：和compact相比多了n_field和1byte_offs_flag这两个属性，且没有record_type属性。

​					1byte_offs_flag：表明每个列的偏移量使用1个字节还是2个字节表示。当记录的真实数据占用的字节数不大于127时，每个列对应的偏移量占用1个字节，此值为1；大于127但不大于32767时，占用2个字节，此值为0。

##### 	2.记录的真实数据

​				如果存储null值的字段是变长数据类型的，不在记录的真实数据占用任何存储空间。如果存储null值的字段是定长类型，是存储的。

​				char(M)在redundant中存储不管什么字符集都是使用最大空间，这样不会产生碎片。

#### dynamic

#### compressed

会采用压缩算法对页面进行压缩。

这两种行格式类似redundant但是在处理溢出数据（当前页放不下记录中的数据，会把多余的数据存到其他页）时有所不同。



#### TODO 行溢出数据